name: Run PRRC Connector

on:
  schedule:
    - cron: "0 8 * * *"  # 3:00 AM EST (8:00 UTC)
  workflow_dispatch:

jobs:
  run-connector:
    runs-on: ubuntu-latest

    env:
      RICS_API_TOKEN: ${{ secrets.RICS_API_TOKEN }}
      RICS_STORE_CODES: ${{ secrets.RICS_STORE_CODES }}
      GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}   # ‚úÖ use only this
      GDRIVE_FOLDER_ID_RICS: ${{ secrets.GDRIVE_FOLDER_ID_RICS }}
      OPTIMIZELY_API_TOKEN: ${{ secrets.OPTIMIZELY_API_TOKEN }}
      META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
      META_OFFLINE_EVENT_SET_ID: ${{ secrets.META_OFFLINE_EVENT_SET_ID }}
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: üì¶ Install dependencies
        run: pip install -r requirements.txt

      - name: üß™ Sanity check secrets
        run: |
          python - <<'PY'
          import os, json
          creds = os.getenv("GDRIVE_CREDENTIALS")
          folder = os.getenv("GDRIVE_FOLDER_ID_RICS")
          print("‚úÖ GDRIVE_CREDENTIALS present:", bool(creds))
          print("‚úÖ Folder ID:", folder)
          try:
              info = json.loads(creds)
              print("‚úÖ Service account email:", info.get("client_email"))
          except Exception as e:
              print("‚ùå Failed to parse GDRIVE_CREDENTIALS:", e)
          PY

      - name: üü¢ Run RICS fetch + dedupe + upload
        run: python scripts/sync_rics_live.py

      - name: üì§ Sync to Optimizely
        run: python scripts/sync_to_optimizely.py rics_customer_purchase_history_deduped.csv

      - name: üì§ Sync to Meta (Offline Events)
        run: python scripts/sync_rics_to_meta.py rics_customer_purchase_history_deduped.csv
