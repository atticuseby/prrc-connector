name: Run PRRC Connector

on:
  workflow_dispatch: # run manually from Actions tab
    inputs:
      sync_type:
        description: 'Sync type: "daily" (1 day) or "initial" (45 days catch-up)'
        required: false
        default: 'daily'
        type: choice
        options:
          - daily
          - initial
  schedule:
    - cron: '0 9 * * *' # Run daily at 9:00 AM UTC (4:00 AM EST)

jobs:
  run-connector:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine sync type and lookback days
        id: sync_config
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # Scheduled runs are always daily (1 day)
            echo "sync_type=daily" >> $GITHUB_OUTPUT
            echo "lookback_days=1" >> $GITHUB_OUTPUT
            echo "ðŸ“… Scheduled run: Using 1 day lookback (daily sync)"
          else
            # Manual runs use the input parameter
            SYNC_TYPE="${{ inputs.sync_type || 'daily' }}"
            echo "sync_type=$SYNC_TYPE" >> $GITHUB_OUTPUT
            if [ "$SYNC_TYPE" == "initial" ]; then
              echo "lookback_days=45" >> $GITHUB_OUTPUT
              echo "ðŸ“… Initial sync: Using 45 day lookback (catch-up)"
            else
              echo "lookback_days=1" >> $GITHUB_OUTPUT
              echo "ðŸ“… Daily sync: Using 1 day lookback"
            fi
          fi

      - name: Sanity check secrets
        run: |
          python - <<EOF
          import os
          print("RICS_API_TOKEN present:", bool(os.getenv("RICS_API_TOKEN")))
          print("META_ACCESS_TOKEN present:", bool(os.getenv("META_ACCESS_TOKEN")))
          print("META_DATASET_ID present:", bool(os.getenv("META_DATASET_ID")))
          print("OPTIMIZELY_API_KEY present:", bool(os.getenv("OPTIMIZELY_API_KEY")))
          print("Google Drive service account:", os.getenv("GDRIVE_SERVICE_ACCOUNT", "Not found"))
          EOF
        env:
          RICS_API_TOKEN: ${{ secrets.RICS_API_TOKEN }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
          META_DATASET_ID: ${{ secrets.META_OFFLINE_EVENT_SET_ID }}
          OPTIMIZELY_API_KEY: ${{ secrets.OPTIMIZELY_API_TOKEN }}
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_CREDENTIALS }}

      - name: Run RICS fetch + dedupe + upload
        run: python scripts/sync_rics_live.py --debug
        env:
          RICS_API_TOKEN: ${{ secrets.RICS_API_TOKEN }}
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
          GDRIVE_FOLDER_ID_RICS: ${{ secrets.GDRIVE_FOLDER_ID_RICS }}
          RICS_LOOKBACK_DAYS: ${{ steps.sync_config.outputs.lookback_days }}

      - name: Sync to Optimizely
        run: python rics_connector/sync_rics_to_optimizely.py rics_customer_purchase_history_deduped.csv
        env:
          OPTIMIZELY_API_TOKEN: ${{ secrets.OPTIMIZELY_API_TOKEN }}
          OPTIMIZELY_LIST_ID_RICS: ${{ secrets.OPTIMIZELY_LIST_ID_RICS }}
          DRY_RUN: ${{ secrets.DRY_RUN }}
          RICS_TEST_MODE: ${{ secrets.RICS_TEST_MODE || 'false' }}
          RICS_TEST_EMAIL: ${{ secrets.RICS_TEST_EMAIL || '' }}
          RICS_TEST_NAME: ${{ secrets.RICS_TEST_NAME || '' }}
          RICS_TEST_EMAIL_FILTER: ${{ secrets.RICS_TEST_EMAIL_FILTER || '' }}
          RICS_DISABLE_DEDUPLICATION: ${{ secrets.RICS_DISABLE_DEDUPLICATION || 'false' }}

      - name: Sync to Meta (Offline Events)
        run: python scripts/sync_rics_to_meta.py rics_customer_purchase_history_deduped.csv
        env:
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
          META_DATASET_ID: ${{ secrets.META_OFFLINE_EVENT_SET_ID }}

  validate-rics-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run RICS Token Validator
        env:
          RICS_API_TOKEN: ${{ secrets.RICS_API_TOKEN }}
        run: python scripts/validate_rics_token.py
