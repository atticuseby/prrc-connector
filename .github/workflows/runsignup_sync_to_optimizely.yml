name: Sync RunSignUp Data to Optimizely

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Download RunSignUp CSVs (All Partners)"]
    types:
      - completed

jobs:
  sync-to-optimizely:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    env:
      OPTIMIZELY_API_TOKEN: ${{ secrets.OPTIMIZELY_API_TOKEN }}
      GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
      RSU_FOLDER_IDS: ${{ secrets.RSU_FOLDER_IDS }}
      GDRIVE_FOLDER_ID_1384: ${{ secrets.GDRIVE_FOLDER_ID_1384 }}
      GDRIVE_FOLDER_ID_1385: ${{ secrets.GDRIVE_FOLDER_ID_1385 }}
      GDRIVE_FOLDER_ID_1411: ${{ secrets.GDRIVE_FOLDER_ID_1411 }}
      OPTIMIZELY_LIST_ID_1384: ${{ secrets.OPTIMIZELY_LIST_ID_1384 }}
      OPTIMIZELY_LIST_ID_1385: ${{ secrets.OPTIMIZELY_LIST_ID_1385 }}
      OPTIMIZELY_LIST_ID_1411: ${{ secrets.OPTIMIZELY_LIST_ID_1411 }}
      DRY_RUN: ${{ secrets.DRY_RUN }}
      OPTIMIZELY_EVENT_NAME: ${{ secrets.OPTIMIZELY_EVENT_NAME || 'registration' }}

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install Python dependencies
        run: pip install -r requirements.txt

      - name: ðŸ”§ Set PYTHONPATH
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV

      - name: ðŸ§ª Sanity import
        run: |
          python - <<'PY'
          import os, sys
          print("PYTHONPATH:", os.getenv("PYTHONPATH"))
          try:
              import runsignup_connector.main_runsignup as m
              import runsignup_connector.optimizely_client
              from scripts.process_runsignup_csvs import process_runsignup_csvs
              print("âœ… Sanity import ok")
          except ImportError as e:
              print(f"âŒ Import error: {e}")
              sys.exit(1)
          PY

      - name: ðŸ§ª Run import tests
        run: python tests/test_imports.py

      - name: ðŸ”„ Process & sync to Optimizely
        timeout-minutes: 360  # 6 hours max (GitHub Actions default, but explicit)
        run: python -m runsignup_connector.main_runsignup
