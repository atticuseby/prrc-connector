# Testing One Customer at a Time - RICS to Optimizely Sync

This guide explains how to test the RICS to Optimizely sync with a single customer before syncing the entire batch.

## üß™ Test Mode Overview

The `sync_rics_to_optimizely.py` script has a built-in test mode that:
- Processes only **5 rows** from the CSV
- Can filter by customer name or email
- Overrides all emails with your test email (so all events go to your test customer)
- Still posts real data to Optimizely (when `DRY_RUN=false`)

## üìã Required GitHub Secrets

Set these secrets in your GitHub repository (Settings ‚Üí Secrets and variables ‚Üí Actions):

### Required for Testing:
1. **`RICS_TEST_MODE`** = `"true"` (enables test mode)
2. **`RICS_TEST_EMAIL`** = Your test email address (e.g., `"test@example.com"`)
3. **`DRY_RUN`** = `"false"` (to actually post data - set to `"true"` for dry run)

### Optional Filters (choose one):
4. **`RICS_TEST_NAME`** = Customer name to filter by (case-insensitive partial match)
   - Example: `"John Smith"` will match "John Smith", "john smith", "John Smith Jr", etc.
   
   **OR**
   
5. **`RICS_TEST_EMAIL_FILTER`** = Customer email to filter by (more reliable than name)
   - Example: `"customer@example.com"` (matches exact email in CSV)

### Other Required Secrets:
- `OPTIMIZELY_API_TOKEN` - Your Optimizely API token
- `OPTIMIZELY_LIST_ID_RICS` - List ID (defaults to `"base_store_purchases_only"` if not set)
- `RICS_API_TOKEN` - RICS API token (for fetching data)

## üöÄ How to Test One Customer

### Option 1: Filter by Customer Name (Easier)

1. **Set GitHub Secrets:**
   ```
   RICS_TEST_MODE = "true"
   RICS_TEST_EMAIL = "your-test-email@example.com"
   RICS_TEST_NAME = "Customer Name Here"  # Partial match is fine
   DRY_RUN = "false"
   ```

2. **Run the workflow manually:**
   - Go to Actions ‚Üí "Run PRRC Connector"
   - Click "Run workflow"
   - Select sync type (daily or initial)
   - Click "Run workflow"

3. **What happens:**
   - Script finds rows matching the customer name
   - Processes up to 5 matching rows
   - Overrides all emails with `RICS_TEST_EMAIL`
   - Posts purchase events to Optimizely for your test email
   - Subscribes test email to the list

4. **Check Optimizely:**
   - Log into Optimizely
   - Search for your test email
   - Verify:
     - Profile was created/updated
     - Purchase events are present
     - Customer is subscribed to the list

### Option 2: Filter by Customer Email (More Reliable)

1. **Set GitHub Secrets:**
   ```
   RICS_TEST_MODE = "true"
   RICS_TEST_EMAIL = "your-test-email@example.com"
   RICS_TEST_EMAIL_FILTER = "customer-email-in-csv@example.com"
   DRY_RUN = "false"
   ```

2. **Run the workflow** (same as Option 1)

3. **What happens:**
   - Script finds rows matching the customer email
   - Processes up to 5 matching rows
   - Overrides all emails with `RICS_TEST_EMAIL`
   - Posts purchase events to Optimizely

## üîç Understanding the Test Mode Behavior

### What Test Mode Does:
- ‚úÖ Processes only **5 rows** (prevents accidentally syncing too much)
- ‚úÖ **Filters** by name or email (finds your test customer)
- ‚úÖ **Overrides emails** with `RICS_TEST_EMAIL` (all events go to your test account)
- ‚úÖ **Posts real data** to Optimizely (when `DRY_RUN=false`)
- ‚úÖ **Respects deduplication** (won't create duplicate events)

### What Test Mode Does NOT Do:
- ‚ùå Process all rows (only 5)
- ‚ùå Skip deduplication (still checks for duplicates)
- ‚ùå Skip API calls (still posts to Optimizely)

## üéØ Step-by-Step Testing Workflow

### Step 1: Find Your Test Customer
1. Look at the CSV file generated by `sync_rics_live.py`
2. Find a customer you want to test with
3. Note their name or email

### Step 2: Set Up GitHub Secrets
1. Go to your GitHub repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
2. Set the secrets listed above
3. Make sure `DRY_RUN = "false"` to actually post data

### Step 3: Run the Workflow
1. Go to Actions tab
2. Click "Run PRRC Connector"
3. Click "Run workflow"
4. Select "daily" or "initial" sync type
5. Click "Run workflow"

### Step 4: Monitor the Run
1. Click on the running workflow
2. Expand "Sync to Optimizely" step
3. Look for:
   - `üß™ TEST MODE: Only processing first 5 rows`
   - `‚úÖ MATCH FOUND: 'Customer Name' contains 'Filter'`
   - `üìù Processing row X (email: your-test-email@example.com)`
   - `Posted profiles: X`
   - `Posted events: X`

### Step 5: Verify in Optimizely
1. Log into Optimizely
2. Search for your test email
3. Check:
   - **Profile** exists with correct attributes
   - **Purchase events** are present (check Events tab)
   - **List subscription** status (should be subscribed to `base_store_purchases_only`)

### Step 6: Test Again or Go Live
- **If test worked:** Set `RICS_TEST_MODE = "false"` and run again to sync all customers
- **If test failed:** Check logs, fix issues, and test again

## üêõ Troubleshooting

### "No matching rows found"
- **Problem:** Customer name/email filter didn't match any rows
- **Solution:** 
  - Check the CSV file to see exact customer name/email
  - Use `RICS_TEST_EMAIL_FILTER` instead of `RICS_TEST_NAME` (more reliable)
  - Make sure the customer has purchases in the date range

### "TEST MODE: Reached max rows (5), stopping processing"
- **This is normal!** Test mode only processes 5 rows
- If you want to test more, you'd need to modify `RICS_TEST_MAX_ROWS` in the code (not recommended)

### "Skipped duplicate events"
- **This is normal!** The script checks for duplicates before posting
- If you see this, the event was already posted in a previous run
- To test again, you'd need to clear the deduplication log (not recommended for production)

### Events not showing in Optimizely
- **Check:** Is `DRY_RUN = "false"`? (Dry run doesn't post data)
- **Check:** Are there any errors in the workflow logs?
- **Check:** Is the Optimizely API token valid?
- **Wait:** Optimizely can take a few minutes to process events

## üìù Example GitHub Secrets Configuration

```
# Enable test mode
RICS_TEST_MODE = "true"

# Your test email (where all events will go)
RICS_TEST_EMAIL = "test@yourdomain.com"

# Filter by customer name (partial match)
RICS_TEST_NAME = "John"

# OR filter by customer email (exact match, more reliable)
# RICS_TEST_EMAIL_FILTER = "customer@example.com"

# Actually post data (set to "true" for dry run)
DRY_RUN = "false"

# Optimizely credentials
OPTIMIZELY_API_TOKEN = "your-token-here"
OPTIMIZELY_LIST_ID_RICS = "base_store_purchases_only"  # Optional, has default
```

## ‚úÖ Ready to Go Live?

Once you've verified the test customer appears correctly in Optimizely:

1. **Set `RICS_TEST_MODE = "false"`** in GitHub Secrets
2. **Keep `DRY_RUN = "false"`** to post real data
3. **Run the workflow** - it will now process ALL customers
4. **Monitor the run** - check the summary at the end for counts

The script will:
- Process all rows in the CSV
- Post purchase events for all customers
- Subscribe customers to the email list
- Respect existing unsubscribes (won't re-subscribe if previously unsubscribed)

